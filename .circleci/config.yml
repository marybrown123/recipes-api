version: 2.1
commands:
  restore-cache:
    steps:
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            - v1-dependencies-
  install-dependencies:
    steps: 
      - run: npm install
  save-cache:
    steps:
      - save_cache:
          key: v1-dependencies-{{ checksum "package-lock.json" }}
          paths:
            - ./node_modules
  generate-prisma-client:
    steps:
      - run: npx prisma generate
  generate-prisma-migrations:
    steps:
      - run: npx prisma migrate dev
  deploy-prisma-migrations:
    steps:
      - run: npx prisma migrate deploy --preview-feature
  run-tests:
    steps:
      - run: npm run test:ci 
      - run: npm run test:e2e 
  greetings-from-branch:
    steps:
      - run: echo "No siema z brancha <<pipeline.git.branch>>"
executors:
  executor:
    docker: 
      - image: cimg/node:18.16.0
        environment:
          NODE_ENV: test
          PGHOST: 127.0.0.1
          PGUSER: root
      - image: cimg/postgres:14.1
        environment:
          POSTGRES_USER: testUser
          POSTGRES_DB: test
          POSTGRES_PASSWORD: testPassword
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
jobs:
  install-dependencies:
    executor: executor
    steps:
      - checkout
      - restore-cache
      - install-dependencies
      - save-cache
  prisma:
    executor: executor
    steps:
      - checkout
      - restore-cache
      - generate-prisma-client
      - generate-prisma-migrations
      - persist_to_workspace:
          root: .
          paths:
            - prisma
  run-tests:
    executor: executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - deploy-prisma-migrations
      - restore-cache
      - run-tests
  greetings-from-branch:
    executor: executor
    steps:
      - checkout
      - greetings-from-branch
  
workflows:
  version: 2.1
  build-and-test:
    jobs:
      - install-dependencies
      - prisma:
          requires: 
            - install-dependencies
      - run-tests:
          requires: 
            - prisma
      - greetings-from-branch:
          requires: 
            - run-tests


